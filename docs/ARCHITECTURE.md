# 系统架构文档

## 概述

拾光博客是一个现代化的全栈博客系统，采用微服务架构思想，具备高可用性和可扩展性。

## 架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户浏览器     │    │   CDN/静态资源   │    │   第三方服务     │
│  (Next.js前端)   │◄──►│    (Vercel)     │◄──►│ (Supabase等)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   API网关层      │    │   静态资源层     │    │   服务集成层     │
│ (Next.js API)    │    │  (Next.js静态)   │    │ (第三方API)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   业务逻辑层     │    │   数据访问层     │    │   基础设施层     │
│ (Services)      │◄──►│ (Supabase ORM)   │◄──►│ (数据库/缓存)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 技术架构

### 前端架构

#### 框架选择
- **Next.js 16**: React全栈框架，支持SSR/SSG/CSR
- **React 19**: 最新的React版本，性能更好
- **TypeScript**: 静态类型检查，提高代码质量

#### 状态管理
- **React Context**: 轻量级状态管理
- **自定义Hooks**: 业务逻辑封装
- **组件级状态**: 局部状态管理

#### 样式架构
- **Tailwind CSS**: 实用优先的CSS框架
- **CSS变量**: 主题和颜色管理
- **响应式设计**: 移动优先的设计理念

### 后端架构

#### API架构
- **App Router**: Next.js 13+的新路由系统
- **边缘函数**: 全球分布式部署
- **中间件**: 请求处理和验证

#### 数据架构
- **Supabase**: PostgreSQL + Realtime
- **Row Level Security**: 数据库级别的权限控制
- **API Routes**: RESTful API端点

### 基础设施架构

#### 部署架构
- **Vercel**: 无服务器部署平台
- **Docker**: 容器化部署选项
- **GitHub Actions**: CI/CD自动化

#### 监控架构
- **Sentry**: 前后端错误监控
- **Winston**: 服务端日志系统
- **自定义监控**: 业务指标追踪

## 数据流设计

### 用户请求处理流程

```
用户请求 → CDN缓存 → Next.js路由 → 中间件处理 → 
API路由 → 业务逻辑 → 数据库查询 → 响应返回
```

### 数据库设计

#### 核心表结构

**posts表**
```sql
CREATE TABLE posts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title VARCHAR(255) NOT NULL,
  slug VARCHAR(255) UNIQUE NOT NULL,
  content TEXT,
  excerpt TEXT,
  cover_image TEXT,
  category VARCHAR(100),
  tags TEXT[],
  status VARCHAR(20) DEFAULT 'draft',
  views INTEGER DEFAULT 0,
  likes INTEGER DEFAULT 0,
  author_id UUID REFERENCES profiles(id),
  published_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**profiles表**
```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  name VARCHAR(100),
  bio TEXT,
  avatar TEXT,
  social JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 缓存策略

#### 多级缓存
1. **浏览器缓存**: 静态资源缓存
2. **CDN缓存**: 全球边缘节点缓存
3. **应用缓存**: Redis内存缓存
4. **数据库缓存**: 查询结果缓存

#### 缓存失效策略
- **时间失效**: TTL设置
- **事件驱动**: 数据变更时清除缓存
- **LRU算法**: 内存不足时自动清理

## 安全架构

### 认证授权
- **JWT Token**: 无状态认证
- **Session管理**: 服务端会话存储
- **RBAC**: 基于角色的访问控制

### 数据安全
- **SSL/TLS**: 全站HTTPS
- **数据加密**: 敏感信息加密存储
- **输入验证**: 严格的参数校验
- **SQL注入防护**: 参数化查询

### 网络安全
- **CORS策略**: 跨域资源共享控制
- **CSRF保护**: 跨站请求伪造防护
- **速率限制**: 防止恶意请求
- **DDoS防护**: 分布式拒绝服务攻击防护

## 性能优化

### 前端优化
- **代码分割**: 按需加载组件
- **图片优化**: WebP格式 + 懒加载
- **资源预加载**: 关键资源提前加载
- **服务工作者**: 离线缓存支持

### 后端优化
- **数据库索引**: 查询性能优化
- **连接池**: 数据库连接复用
- **异步处理**: 非阻塞IO操作
- **批处理**: 批量操作减少请求次数

### 基础设施优化
- **CDN加速**: 静态资源全球分发
- **负载均衡**: 请求分发和故障转移
- **自动扩缩容**: 根据流量自动调整资源
- **监控告警**: 性能异常及时发现

## 可扩展性设计

### 水平扩展
- **无状态服务**: 支持多实例部署
- **分布式缓存**: Redis集群
- **数据库分片**: 数据水平切分
- **消息队列**: 异步任务处理

### 垂直扩展
- **资源弹性**: CPU/内存动态调整
- **存储扩容**: 对象存储无限扩展
- **带宽升级**: 网络资源按需增加

## 监控和运维

### 监控体系
- **应用监控**: 业务指标追踪
- **基础设施监控**: 系统资源监控
- **用户体验监控**: 页面性能监测
- **错误监控**: 异常捕获和报警

### 日志体系
- **结构化日志**: 统一日志格式
- **日志分级**: 不同级别日志分离
- **日志轮转**: 自动清理过期日志
- **日志分析**: 异常模式识别

### 运维自动化
- **CI/CD**: 持续集成和部署
- **配置管理**: 基础设施即代码
- **备份恢复**: 自动化数据保护
- **故障自愈**: 异常自动处理

## 部署架构

### 开发环境
- 本地开发服务器
- 热重载和调试工具
- 模拟数据和Mock服务

### 测试环境
- 自动化测试流水线
- 性能基准测试
- 安全漏洞扫描

### 生产环境
- 多区域部署
- 蓝绿部署策略
- 灰度发布机制
- 回滚方案

## 未来发展规划

### 短期目标（3-6个月）
- 移动端优化
- 搜索功能增强
- 社交分享完善

### 中期目标（6-12个月）
- 微服务拆分
- 实时通信功能
- AI内容推荐

### 长期目标（1-2年）
- 多租户支持
- 插件生态系统
- 开放API平台

---
*架构文档最后更新：2026年1月*